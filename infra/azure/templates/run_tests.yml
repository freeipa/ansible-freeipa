---
parameters:
  - name: group_number
    type: number
    default: 1
  - name: number_of_groups
    type: number
    default: 1
  - name: distro
    type: string
    default: fedora-latest
  - name: ansible_version
    type: string
    default: ""
  - name: python_version
    type: string
    default: 3.x
  - name: build_number
    type: string
  - name: skip_git_test
    type: boolean
    default: true
  - name: test_type
    type: string
    default: "playbook"
  - name: test_galaxy
    type: boolean
    default: false

jobs:
- job: Test_Group${{ parameters.group_number }}
  displayName: Run playbook tests ${{ parameters.distro }} (${{ parameters.group_number }}/${{ parameters.number_of_groups }})
  timeoutInMinutes: 360
  variables:
  - template: variables.yaml
  - template: variables_${{ parameters.distro }}.yaml
  steps:
  - template: prepare_environment.yaml
    parameters:
      build_number: ${{ parameters.build_number }}
      distro: ${{ parameters.distro }}
      ansible_version: ${{ parameters.ansible_version }}
      python_version: ${{ parameters.python_version }}

  # This will set environmnet variable "TOPDIR" on all script tasks
  - bash: echo "##vso[task.setvariable variable=TOPDIR]${PWD}"
    displayName: Set repo rootdir

  - script: |
      . "${TOPDIR}/infra/azure/scripts/set_test_modules"
      python3 utils/check_test_configuration.py ${{ parameters.distro }}
    displayName: Check test configuration
    env:
       SKIP_GIT_TEST: ${{ parameters.skip_git_test }}

  - script: |
      # Run tests
      infra/scenarios/run_test_scenario.sh -k -vvv
    displayName: Run playbook tests
    env:
      SKIP_GIT_TEST: ${{ parameters.skip_git_test }}
      ${{ if not(parameters.test_galaxy) }}:
        ANSIBLE_ROLES_PATH: "${PWD}/roles"
        ANSIBLE_LIBRARY: "${PWD}/plugins"
        ANSIBLE_MODULE_UTILS: "${PWD}/plugins/module_utils"
      ${{ if parameters.test_galaxy }}:
        ANSIBLE_COLLECTIONS_PATH: "${HOME}/.ansible/collections/ansible_collections"
      IPA_DISABLED_MODULES: ${{ variables.ipa_disabled_modules }}
      IPA_DISABLED_TESTS: ${{ variables.ipa_disabled_tests }}
      IPA_ENABLED_MODULES: ${{ variables.ipa_enabled_modules }}
      IPA_ENABLED_TESTS: ${{ variables.ipa_enabled_tests }}
