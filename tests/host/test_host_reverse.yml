---
- name: Test host
  hosts: ipaserver
  become: true
  gather_facts: true

  tasks:
  - name: Get Domain from server name
    set_fact:
      ipaserver_domain: "{{ ansible_fqdn.split('.')[1:] | join ('.') }}"
    when: ipaserver_domain is not defined

  - name: Set host1_fqdn
    set_fact:
      host1_fqdn: "{{ 'host1.' + ipaserver_domain }}"

  - name: Host absent
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name:
      - "{{ host1_fqdn }}"
      update_dns: yes
      state: absent

  - name: Remove reverse IPv4 zones.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: "{{ ansible_default_ipv4.address.split('.')[item::-1] | join('.') }}.in-addr.arpa."
      state: absent
    with_items:
      - 0
      - 1
      - 2

  - name: Remove reverse IPv6 zones.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: ip6.arpa
      state: absent

  - name: Get IPv4 address prefix from server node
    set_fact:
      ipv4_prefix: "{{ ansible_default_ipv4.address.split('.')[:-1] |
                       join('.') }}"

  - name: Set zone for reverse IPv6 address.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: ip6.arpa
      skip_overlap_check: yes

  - name: Set zone for reverse IPv4 address.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: "{{ ansible_default_ipv4.address.split('.')[item::-1] | join('.') }}.in-addr.arpa."
      skip_overlap_check: yes
    with_items:
      - 0
      - 1
      - 2

  - name: Host "{{ host1_fqdn }}" present
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name: "{{ host1_fqdn }}"
      ip_address: "{{ ipv4_prefix + '.201' }}"
      update_dns: yes
      reverse: yes
    register: result
    failed_when: not result.changed

  - name: Host "{{ host1_fqdn }}" present, again.
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name: "{{ host1_fqdn }}"
      ip_address: "{{ ipv4_prefix + '.201' }}"
      update_dns: yes
      reverse: yes
    register: result
    failed_when: result.changed

  - name: Hosts host1 absent
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name:
      - "{{ host1_fqdn }}"
      update_dns: yes
      state: absent
    register: result
    failed_when: not result.changed

  - name: Host "{{ host1_fqdn }}" present with IPv6
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name: "{{ host1_fqdn }}"
      ip_address: "fd00::0001"
      update_dns: yes
      reverse: yes
    register: result
    failed_when: not result.changed

  - name: Host "{{ host1_fqdn }}" present with IPv6, again.
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name: "{{ host1_fqdn }}"
      ip_address: "fd00::0001"
      update_dns: yes
      reverse: yes
    register: result
    failed_when: result.changed

  - name: Hosts host1 absent
    ipahost:
      ipaadmin_password: SomeADMINpassword
      name:
      - "{{ host1_fqdn }}"
      update_dns: yes
      state: absent
    register: result
    failed_when: not result.changed

  - name: Remove reverse IPv4 zones.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: "{{ ansible_default_ipv4.address.split('.')[item::-1] | join('.') }}.in-addr.arpa."
      state: absent
    with_items:
      - 0
      - 1
      - 2

  - name: Remove reverse IPv6 zones.
    ipadnszone:
      ipaadmin_password: SomeADMINpassword
      name: ip6.arpa
      state: absent
