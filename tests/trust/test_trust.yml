---
- name: find trust
  hosts: "{{ ipa_test_host | default('ipaserver') }}"
  become: true
  gather_facts: false

  vars:
    adserver:
      domain: "{{ winserver_domain | default('windows.local')}}"
      realm: "{{ winserver_realm | default(winserver_domain) | default('windows.local') | upper }}"
    trust_exists: 'Realm name: {{ adserver.domain }}'
    range_exists: 'Range name: {{ adserver.realm }}_id_range'

  tasks:

  - block:

    - name: delete trust
      ipatrust:
        ipaadmin_password: SomeADMINpassword
        ipaapi_context: "{{ ipa_context | default(omit) }}"
        realm: windows.local
        state: absent
      register: del_trust

    - name: check for trust
      shell: |
        echo 'SomeADMINpassword' | kinit admin
        ipa trust-find windows.local
      register: check_find_trust
      failed_when: "trust_exists in check_find_trust.stdout"

    - name: delete id range
      shell: |
        echo 'SomeADMINpassword' | kinit admin
        ipa idrange-del WINDOWS.LOCAL_id_range
      when: del_trust['changed'] | bool

    - name: check for range
      shell: |
        echo 'SomeADMINpassword' | kinit admin
        ipa idrange-find WINDOWS.LOCAL_id_range
      register: check_del_idrange
      failed_when: "range_exists in check_find_trust.stdout"

    - name: add trust
      ipatrust:
        ipaadmin_password: SomeADMINpassword
        ipaapi_context: "{{ ipa_context | default(omit) }}"
        realm: windows.local
        admin: Administrator
        password: secret_ad_pw
        state: present

    - name: check for trust
      shell: |
        echo 'SomeADMINpassword' | kinit admin
        ipa trust-find windows.local
      register: check_add_trust
      failed_when: "trust_exists in check_find_trust.stdout"

    when: trust_test_is_supported | default(false)
