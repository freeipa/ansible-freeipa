---
- name: Test group
  hosts: ipaserver
  become: true
  gather_facts: true

  tasks:
    # setup

    - name: Remove testing groups.
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name:
        - extgroup
        - nonposixgroup
        - posixgroup
        state: absent

    - name: Ensure test users testuser1, testuser2 and testuser3 are absent
      ipauser:
        ipaadmin_password: SomeADMINpassword
        name: testuser1,testuser2,testuser3
        state: absent

    - name: Ensure test users testuser1..testuser3 are present
      ipauser:
        ipaadmin_password: SomeADMINpassword
        users:
        - name: testuser1
          first: testuser1
          last: Last
        - name: testuser2
          first: testuser2
          last: Last
        - name: testuser3
          first: testuser3
          last: Last
      register: result
      failed_when: not result.changed or result.failed

    # start tests

    - name: Ensure group extgroup exists and is external
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup
        external: true
      register: result
      failed_when: result.failed or not result.changed

    - name: Ensure group extgroup exists and is external, again
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup
        external: true
      register: result
      failed_when: result.failed or result.changed

    - name: Ensure group extgroup exists and is nonposix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup
        nonposix: true
      register: result
      failed_when: result.failed or result.changed

    - name: Ensure group extgroup exists and is not external
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup
        external: false
      register: result
      failed_when: not result.failed or "group can not be non-external" not in result.msg

    - name: Ensure group extgroup exists and is posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup
        posix: true
      register: result
      failed_when: not result.failed or "Cannot change `external` group" not in result.msg

    - name: Ensure group posixgroup exists and is nonposix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        nonposix: true
      register: result
      failed_when: result.failed or not result.changed

    - name: Ensure group posixgroup exists and is posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: true
      register: result
      failed_when: result.failed or not result.changed

    - name: Ensure group posixgroup exists and is posix, again
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: true
      register: result
      failed_when: result.failed or result.changed

    - name: Ensure group posixgroup exists and is external
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        external: true
      register: result
      failed_when: not result.failed or "Cannot change `posix` group" not in result.msg

    - name: Ensure group posixgroup exists and is not posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: false
      register: result
      failed_when: not result.failed or "Cannot change `posix` group" not in result.msg

    - name: Ensure group posixgroup exists and is nonposix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        nonposix: true
      register: result
      failed_when: not result.failed or "Cannot change `posix` group" not in result.msg

    - name: Ensure group nonposixgroup exists and is nonposix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        nonposix: true
      register: result
      failed_when: result.failed or not result.changed

    - name: Ensure group nonposixgroup exists and is not posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        posix: false
      register: result
      failed_when: result.failed or result.changed

    # NONPOSIX MEMBER TEST

    - name: Ensure users testuser1, testuser2 and testuser3 are present in group nonposixgroup
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        nonposix: true
        user:
        - testuser1
        - testuser2
        - testuser3
      register: result
      failed_when: not result.changed or result.failed

    - name: Ensure users testuser1, testuser2 and testuser3 are present in group nonposixgroup again
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        nonposix: true
        user:
        - testuser1
        - testuser2
        - testuser3
      register: result
      failed_when: result.changed or result.failed


    # POSIX MEMBER TEST

    - name: Ensure users testuser1, testuser2 and testuser3 are present in group posixgroup
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: true
        user:
        - testuser1
        - testuser2
        - testuser3
      register: result
      failed_when: not result.changed or result.failed

    - name: Ensure users testuser1, testuser2 and testuser3 are present in group posixgroup again
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: true
        user:
        - testuser1
        - testuser2
        - testuser3
      register: result
      failed_when: result.changed or result.failed

    # EXTERNAL MEMBER TEST (REQUIRES AD)

    - name: Execute group tests if trust test environment is supported
      when: trust_test_is_supported | default(false)
      block:

      - name: Ensure users testuser1, testuser2 and testuser3 are present in group externalgroup
        ipagroup:
          ipaadmin_password: SomeADMINpassword
          name: externalgroup
          external: true
          user:
          - testuser1
          - testuser2
          - testuser3
        register: result
        failed_when: not result.changed or result.failed

      - name: Ensure users testuser1, testuser2 and testuser3 are present in group externalgroup again
        ipagroup:
          ipaadmin_password: SomeADMINpassword
          name: externalgroup
          external: true
          user:
          - testuser1
          - testuser2
          - testuser3
        register: result
        failed_when: result.changed or result.failed

    # CONVERT NONPOSIX TO POSIX GROUP WITH USERS

    - name: Ensure nonposix group nonposixgroup as posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        posix: true
      register: result
      failed_when: not result.changed or result.failed

    - name: Ensure nonposix group nonposixgroup as posix, again
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        posix: true
      register: result
      failed_when: result.changed or result.failed

    - name: Ensure nonposix group nonposixgroup (now posix) has users still
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: nonposixgroup
        posix: true
        user:
        - testuser1
        - testuser2
        - testuser3
      register: result
      failed_when: result.changed or result.failed

    # FAIL ON COMBINATIONS OF NONPOSIX, POSIX AND EXTERNAL

    - name: Fail to ensure group as nonposix and posix
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        nonposix: true
        posix: true
      register: result
      failed_when: not result.failed or "parameters are mutually exclusive" not in result.msg

    - name: Fail to ensure group as nonposix and external
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        nonposix: true
        external: true
      register: result
      failed_when: not result.failed or "parameters are mutually exclusive" not in result.msg

    - name: Fail to ensure group as posix and external
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: posixgroup
        posix: true
        external: true
      register: result
      failed_when: not result.failed or "parameters are mutually exclusive" not in result.msg

    # CLEANUP

    - name: Remove testing groups.
      ipagroup:
        ipaadmin_password: SomeADMINpassword
        name: extgroup,nonposixgroup,posixgroup
        state: absent

    - name: Ensure test users testuser1, testuser2 and testuser3 are absent
      ipauser:
        ipaadmin_password: SomeADMINpassword
        name: testuser1,testuser2,testuser3
        state: absent
