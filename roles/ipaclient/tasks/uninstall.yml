---
# tasks to uninstall IPA client

- name: Uninstall - Check if ipa-client-install is present
  ansible.builtin.stat:
    path: /usr/sbin/ipa-client-install
  register: __ipa_client_install_available

- name: Uninstall - Perform uninstall
  when: __ipa_client_install_available.stat.exists
  block:
  - name: Uninstall - Uninstall IPA client
    ansible.builtin.command: >
      /usr/sbin/ipa-client-install
      --uninstall
      -U
    register: uninstall
    # 2 means that uninstall failed because IPA client was not configured
    failed_when: uninstall.rc != 0 and uninstall.rc != 2
    changed_when: uninstall.rc == 0

  - name: Uninstall - Unconfigure DNS resolver
    ipaclient_configure_dns_resolver:
      state: absent
    when: ipaclient_cleanup_dns_resolver | bool
